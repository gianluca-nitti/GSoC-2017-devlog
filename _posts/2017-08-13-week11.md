---
date: 2017-08-13
category: week11
---

#### Completed admin permission management, added automatic backups to identity storage server, and added a new feature to the frontend
Another GSoC week has just ended. In the previous post on this blog, I described two features I had added to FacadeServer (and it's web/mobile client): module installation and ability to manipulate settings (server port and MOTD). Both these features, along with the previously developed one which allows to create, rename, backup and delete the various savegames on the server, should only be accessed by a restricted set of users which are the administrators of the server; also, they allow to manipulate server-wide data (installed modules, configuration, list of games), while the existing permission management system in the Terasology engine is designed to manage permissions local to a single savegame (i.e. each savegame directory contain files with information about whether a certain user can use cheats, kick players, etc in that specific game).\\
Thus, during the first part of this week I set up the code for server-wide administration permission management. Here are the key points of this addition:

{:.details}
- The list of users allowed to perform admin-level operations consist in a list of the client IDs of said users, and is stored in a `serverAdmins.json` file in the server data directory (next to the `config.cfg` configuration file).
- When a server is started for the first time (i.e. the data directory specified on the command line does not exist or is empty, so it's created and the server configuration is initialized to the default values), the administrator list will be empty. Also, since there are no savegames, no regular client ever connected, so no client identities have been generated at all. When the list is empty, everyone which can connect to the server using the HTTP/WebSocket API also has access to the admin-restricted features (there would be no way to identify a client in this initial phase).
- After starting a new server, it's recommended to lock the administrative access to the trusted user(s); this can be done by creating a game from the web interface and starting it, then connecting to the server using the regular game client. When the server is in the "empty admin list, public access" phase, in fact, the first user which connects will be added to the admin list. Since the list becomes non-empty, this means that from this moment the access to the admin-only functionalities is no longer public, but restricted to the user which joined the server for the first time. Said user then needs to authenticate to the web interface (by pasting the game client's configuration file or using an identity storage server, as described in older posts on this site) to access these features (so, for example, to add other games, installing other modules, etc.).
- An authenticated user whose ID is in the administrator list can then add other users to the list, to grant them access to the restricted features, or remove them to revoke the permission. Using the proper panel in the web/mobile client, adding a user to the admin list can be done either by manually pasting their client ID in the interface, or, if they are online, by picking their user name from a list.
- If the admin list becomes empty again (which can only happen if an admin removes everyone including himself from it, or if the `serverAdmins.json` file is deleted and the server process restarted), the access to the admin-only features becomes public again, until a player joins through the regular game client as described above.

As usual, the client-side code is in [its repository](https://github.com/gianluca-nitti/FacadeServer-frontend), and the server-side code is on a branch in FacadeServer's repository, [admin-verification](https://github.com/gianluca-nitti/FacadeServer/tree/admin-verification). I'll open a pull request after the previous ones ([#5](https://github.com/MovingBlocks/FacadeServer/pull/5){:.gh-pr}, which introduces the module installation feature, and [#6](https://github.com/MovingBlocks/FacadeServer/pull/6){:.gh-pr}, which allows access to the configuration entries) are merged because I need to fix the classes on their branches to comply with the changes introduced in the `admin-verification` branch.\\
\\
I then moved back to the identity storage service code, to add support for automated backups. Now, when installed using docker, a cron job automatically takes snapshots of the database every day; old backups are deleted after 7 days (meaning you have access to the database dump of every day at midnight in the last week). The backup files are SQL dumps and are stored in a directory mounted on the host machine (using the [docker volumes](https://docs.docker.com/engine/admin/volumes/volumes/) feature).\\
The new code (mostly shell scripts and some changes to the Dockerfiles) is available in the [identity storage service repository](https://github.com/gianluca-nitti/terasology-key-server); I tagged the latest commit after these changes as a new version, [v1.1](https://github.com/gianluca-nitti/terasology-key-server/releases/tag/v1.1). More information about how to install the service on your server are available in the repository's [README file](https://github.com/gianluca-nitti/terasology-key-server/blob/master/README.md#terasology-key-server-).\\
\\
In the final part of the week, I added a feature to the web/mobile client: a "Remember Me"-like checkbox for the authentication process (it was already present in the UI as I planned to add this feature before, but wasn't working). When authenticating to a server, if you select this checkbox and the authentication succeeds, the public and private certificates are stored locally (in the browser's localStorage if using the web-based version or in a proper place in the device's memory if using the mobile application version) and the next time you connect to the same server you will be prompted if you want to authenticate using the stored credentials; if you choose Yes and the credentials are still valid, you will be automatically authenticated without needing to enter other data.\\
Adding this feature also required a quite big refactoring of the client-side authentication code, which was getting less and less readable, but it should be better now. Everything is available in the usual [repository](https://github.com/gianluca-nitti/FacadeServer-frontend) and the web version is deployed on [GitHub pages](https://gianluca-nitti.github.io/FacadeServer-frontend/).
